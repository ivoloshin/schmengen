<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Schengen-Schmengen | 90/180 Day Visa Calculator</title>
    <meta name="description" content="Free Schengen 90/180 calculator. Visualize your travel history, track visa allowance, and find safe start dates to avoid overstaying in the European Union.">
    <meta name="keywords" content="Schengen calculator, 90/180 rule, visa calculator, EU travel, short-stay visa, rolling window, Schengen zone, visa stay limit">
    <meta name="author" content="Schengen-Schmengen">
    <meta name="robots" content="index, follow">
    
    <link rel="canonical" href="https://schmengen.static.domains/" />
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://schmengen.static.domains/">
    <meta property="og:title" content="Schengen-Schmengen | 90/180 Visa Calculator">
    <meta property="og:description" content="Track your EU travel days easily. Visual 90/180 rule calculator.">
    <meta property="og:site_name" content="Schengen-Schmengen">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Schengen-Schmengen | 90/180 Visa Calculator">
    <meta property="twitter:description" content="Track your EU travel days easily. Visual 90/180 rule calculator.">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Schengen-Schmengen",
      "url": "https://schmengen.static.domains",
      "applicationCategory": "TravelApplication",
      "operatingSystem": "Web",
      "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
      "description": "A visual calculator for the Schengen 90/180 visa rule.",
      "featureList": "Visual timeline, Rolling window calculation, Safe start date analysis, Multi-language support"
    }
    </script>

    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Schmengen">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%232563eb' rx='100'/%3E%3Cpath d='M368 128h-32V96h-32v32H208V96h-32v32h-32c-17.6 0-32 14.4-32 32v256c0 17.6 14.4 32 32 32h224c17.6 0 32-14.4 32-32V160c0-17.6-14.4-32-32-32zm0 288H144V208h224v208z' fill='white'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .select-none { -webkit-user-select: none; user-select: none; }
        body { overscroll-behavior-y: none; touch-action: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] w-screen overflow-hidden flex flex-col">
    
    <div id="root" class="w-full h-[calc(100dvh-60px)]"></div>

    <noscript>
        <h1>Schengen-Schmengen: The 90/180 Visa Calculator</h1>
        <p>Calculate your stay in the Schengen Area accurately. This tool helps non-EU citizens track their 90 days within any 180-day rolling window period.</p>
    </noscript>

    <div class="h-[60px] w-full bg-slate-100 border-t border-slate-200 flex justify-center items-center z-50 shrink-0 overflow-hidden">
        <script type="text/javascript">
            atOptions = { 'key' : 'add7e4959065a68ae494723d5301335f', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="//www.highperformanceformat.com/add7e4959065a68ae494723d5301335f/invoke.js"></script>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.error('SW registration failed:', err));
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- LOCALIZATION DATA ---
        const TRANSLATIONS = {
            en: {
                code: 'en-GB', label: 'English', flag: 'üá¨üáß',
                // Header
                subtitle: "Schengen Zone Calculator",
                // UI
                todayCount: "Today's Count", statusSafe: "All good. You are compliant.", statusDanger: "Warning! Overstay on", 
                addBtn: "Add Trip", calendarHeader: "Calendar", delete: "Delete", 
                overlap: "Date already booked.", overlapRange: "Overlap! Dates must be clear.", prompt: "Select End Date",
                prev: "Prev", next: "Next", today: "Today",
                // Timeline Labels
                laneTrips: "Trips", laneAnalysis: "Safe Analysis (Green = 90d Safe Start)",
                limitLabel: "90 DAYS (LIMIT)", graphToday: "TODAY",
                // Help
                helpTitle: "Help & Guide", tabGuide: "How to Use", tabRules: "Schengen Rules",
                interactionTitle: "Interaction Basics", legendTitle: "Color Legend",
                h_tapEmpty: "Double Tap (Empty Space)", h_tapEmptyDesc: "Create a new trip starting on that day.",
                h_tapTrip: "Double Tap (Trip)", h_tapTripDesc: "Delete an existing trip.",
                h_dragBody: "Drag Trip Body", h_dragBodyDesc: "Move the entire trip to new dates.",
                h_dragEdge: "Drag Trip Edge", h_dragEdgeDesc: "Extend or shorten the duration.",
                h_dragTime: "Tap/Drag Timeline", h_dragTimeDesc: "Use the 'Check Tool' to simulate usage for a specific date.",
                safeTrip: "Safe Trip", overstayRisk: "Overstay Risk (>90 days)", safeZone: "Safe Start Zone (90d trip possible)",
                ruleTitle: "The 90/180 Rule", ruleText1: "The Schengen Visa rule states you can stay a maximum of 90 days in any 180-day period.",
                rollingTitle: "It is a Rolling Window", rollingText: "To check if today is legal, the authorities look at the previous 179 days + today.",
                appHelps: "How this app helps:", appHelp1: "It calculates the \"Rolling Window\" for every single day.",
                appHelp2: "The Check Tool (green line) shows you exactly how many days are used in the 180-day window ending on that specific date.",
                appHelp3: "The Safe Analysis Lane highlights green areas where you could legally start a full 90-day trip without violation.",
                disclaimerTitle: "Disclaimer", disclaimerText: "This tool is for estimation only. Verify with official sources.",
                linkText: "Official EU Visa Calculator",
                usedPrior: "Used (Prior 180d)", safeStay: "Safe Stay", sinceLast: "Since Last", untilNext: "Until Next",
                expireMsg: "days expire during stay"
            },
            es: {
                code: 'es-ES', label: 'Espa√±ol', flag: 'üá™üá∏',
                subtitle: "Calculadora Zona Schengen",
                todayCount: "Conteo de Hoy", statusSafe: "Todo bien. Cumples las normas.", statusDanger: "¬°Aviso! Exceso el",
                addBtn: "A√±adir Viaje", calendarHeader: "Calendario", delete: "Borrar",
                overlap: "Fecha ocupada.", overlapRange: "¬°Superposici√≥n! Fechas ocupadas.", prompt: "Selecciona Fin",
                prev: "Ant", next: "Sig", today: "Hoy",
                laneTrips: "Viajes", laneAnalysis: "An√°lisis Seguro (Verde = Inicio 90d)",
                limitLabel: "90 D√çAS (L√çMITE)", graphToday: "HOY",
                helpTitle: "Ayuda", tabGuide: "Uso", tabRules: "Reglas",
                interactionTitle: "Interacci√≥n B√°sica", legendTitle: "Leyenda",
                h_tapEmpty: "Doble toque (vac√≠o)", h_tapEmptyDesc: "Crear un nuevo viaje.",
                h_tapTrip: "Doble toque (viaje)", h_tapTripDesc: "Borrar un viaje existente.",
                h_dragBody: "Arrastrar cuerpo", h_dragBodyDesc: "Mover todo el viaje a nuevas fechas.",
                h_dragEdge: "Arrastrar borde", h_dragEdgeDesc: "Extender o acortar la duraci√≥n.",
                h_dragTime: "Tocar/Arrastrar l√≠nea", h_dragTimeDesc: "Usar herramienta de an√°lisis para simular uso.",
                safeTrip: "Viaje Seguro", overstayRisk: "Riesgo (>90 d√≠as)", safeZone: "Zona Segura (Inicio 90d)",
                ruleTitle: "La Regla 90/180", ruleText1: "Puedes permanecer m√°ximo 90 d√≠as en cualquier periodo de 180 d√≠as.",
                rollingTitle: "Ventana M√≥vil", rollingText: "Las autoridades miran los 179 d√≠as anteriores + hoy.",
                appHelps: "C√≥mo ayuda la app:", appHelp1: "Calcula la ventana m√≥vil para cada d√≠a.",
                appHelp2: "La herramienta de an√°lisis muestra d√≠as usados en la ventana de 180 d√≠as.",
                appHelp3: "La l√≠nea verde muestra d√≥nde puedes iniciar un viaje de 90 d√≠as.",
                disclaimerTitle: "Aviso Legal", disclaimerText: "Solo para estimaci√≥n. Verifique con fuentes oficiales.",
                linkText: "Calculadora Oficial UE",
                usedPrior: "Usado (180d prev)", safeStay: "Estancia Segura", sinceLast: "Desde √∫ltimo", untilNext: "Hasta sig.",
                expireMsg: "d√≠as expiran durante estancia"
            },
            fr: {
                code: 'fr-FR', label: 'Fran√ßais', flag: 'üá´üá∑',
                subtitle: "Calculateur Zone Schengen",
                todayCount: "Compte Actuel", statusSafe: "Tout est bon. Conforme.", statusDanger: "Attention! D√©passement le",
                addBtn: "Ajouter", calendarHeader: "Calendrier", delete: "Supprimer",
                overlap: "Date d√©j√† r√©serv√©e.", overlapRange: "Chevauchement!", prompt: "Fin du voyage",
                prev: "Pr√©c", next: "Suiv", today: "Auj",
                laneTrips: "Voyages", laneAnalysis: "Analyse (Vert = D√©part 90j)",
                limitLabel: "90 JOURS (LIMITE)", graphToday: "AUJ",
                helpTitle: "Aide", tabGuide: "Mode d'emploi", tabRules: "R√®gles",
                interactionTitle: "Interactions", legendTitle: "L√©gende",
                h_tapEmpty: "Double tap (vide)", h_tapEmptyDesc: "Cr√©er un nouveau voyage.",
                h_tapTrip: "Double tap (voyage)", h_tapTripDesc: "Supprimer le voyage.",
                h_dragBody: "Glisser le corps", h_dragBodyDesc: "D√©placer le voyage entier.",
                h_dragEdge: "Glisser le bord", h_dragEdgeDesc: "Modifier la dur√©e.",
                h_dragTime: "Tap/Glisser chrono", h_dragTimeDesc: "Outil d'analyse pour simuler l'utilisation.",
                safeTrip: "Voyage S√ªr", overstayRisk: "Risque (>90 jours)", safeZone: "Zone S√ªre (D√©part 90j)",
                ruleTitle: "R√®gle 90/180", ruleText1: "Maximum 90 jours sur toute p√©riode de 180 jours.",
                rollingTitle: "Fen√™tre Glissante", rollingText: "On regarde les 179 jours pr√©c√©dents + aujourd'hui.",
                appHelps: "L'appli aide:", appHelp1: "Calcule la fen√™tre pour chaque jour.",
                appHelp2: "L'outil d'analyse montre les jours utilis√©s.",
                appHelp3: "La ligne verte indique o√π commencer un voyage de 90 jours.",
                disclaimerTitle: "Avis de non-responsabilit√©", disclaimerText: "Estimation seulement. V√©rifiez sources officielles.",
                linkText: "Calculateur Officiel UE",
                usedPrior: "Utilis√© (180j pr√©c)", safeStay: "Dur√©e S√ªre", sinceLast: "Depuis dernier", untilNext: "Jusqu'au proch.",
                expireMsg: "jours expirent pendant"
            },
            de: {
                code: 'de-DE', label: 'Deutsch', flag: 'üá©üá™',
                subtitle: "Schengen-Raum Rechner",
                todayCount: "Aktueller Stand", statusSafe: "Alles gut. Regelkonform.", statusDanger: "Warnung! √úberzug am",
                addBtn: "Reise +", calendarHeader: "Kalender", delete: "L√∂schen",
                overlap: "Datum belegt.", overlapRange: "√úberschneidung!", prompt: "Enddatum w√§hlen",
                prev: "Zur√ºck", next: "Weiter", today: "Heute",
                laneTrips: "Reisen", laneAnalysis: "Analyse (Gr√ºn = 90T Start)",
                limitLabel: "90 TAGE (LIMIT)", graphToday: "HEUTE",
                helpTitle: "Hilfe", tabGuide: "Anleitung", tabRules: "Regeln",
                interactionTitle: "Bedienung", legendTitle: "Legende",
                h_tapEmpty: "Doppeltipp (Leer)", h_tapEmptyDesc: "Neue Reise erstellen.",
                h_tapTrip: "Doppeltipp (Reise)", h_tapTripDesc: "Reise l√∂schen.",
                h_dragBody: "Reise ziehen", h_dragBodyDesc: "Datum der Reise verschieben.",
                h_dragEdge: "Rand ziehen", h_dragEdgeDesc: "Reisedauer √§ndern.",
                h_dragTime: "Zeitachse ziehen", h_dragTimeDesc: "Analyse-Tool nutzen.",
                safeTrip: "Sicher", overstayRisk: "Risiko (>90 Tage)", safeZone: "Sicherer Start (90T m√∂glich)",
                ruleTitle: "90/180 Regel", ruleText1: "Maximal 90 Tage Aufenthalt in jedem 180-Tage-Zeitraum.",
                rollingTitle: "Rollierendes Fenster", rollingText: "Gez√§hlt werden die letzten 179 Tage + heute.",
                appHelps: "Funktionen:", appHelp1: "Berechnet das Fenster f√ºr jeden Tag.",
                appHelp2: "Zeigt genutzte Tage im 180-Tage-Fenster.",
                appHelp3: "Gr√ºne Linie zeigt sicheren Start f√ºr 90-Tage-Reise.",
                disclaimerTitle: "Haftungsausschluss", disclaimerText: "Nur Sch√§tzung. Offiziell pr√ºfen.",
                linkText: "Offizieller EU Rechner",
                usedPrior: "Benutzt (180T)", safeStay: "M√∂glich", sinceLast: "Seit letztem", untilNext: "Bis n√§chstem",
                expireMsg: "Tage verfallen w√§hrend"
            },
            yi: { 
                code: 'en-GB', label: 'Yiddish', flag: 'ü•Ø',
                subtitle: "Schengen Zone Calculator",
                todayCount: "Today's Count", statusSafe: "Mazel Tov! Everything is kosher.", statusDanger: "Oy Vey! Overstay on",
                addBtn: "Schlep Somewhere", calendarHeader: "The Books", delete: "Feh",
                overlap: "Meshugge! Already booked.", overlapRange: "Overlap! Choose a clear date.", prompt: "When are you coming home?",
                prev: "Prev", next: "Next", today: "Today",
                laneTrips: "Schleps", laneAnalysis: "Kosher Analysis (Green = Safe)",
                limitLabel: "90 DAYS (LIMIT)", graphToday: "TODAY",
                helpTitle: "Help & Guide", tabGuide: "How to Use", tabRules: "Schengen Rules",
                interactionTitle: "Interaction Basics", legendTitle: "Color Legend",
                h_tapEmpty: "Double Tap (Empty)", h_tapEmptyDesc: "Create a new schlep.",
                h_tapTrip: "Double Tap (Trip)", h_tapTripDesc: "Delete a schlep.",
                h_dragBody: "Drag Body", h_dragBodyDesc: "Move the whole megillah.",
                h_dragEdge: "Drag Edge", h_dragEdgeDesc: "Stay longer or shorter.",
                h_dragTime: "Drag Timeline", h_dragTimeDesc: "Check if your dates are kosher.",
                safeTrip: "Safe Trip", overstayRisk: "Overstay Risk (>90 days)", safeZone: "Safe Start Zone (90d trip possible)",
                ruleTitle: "The 90/180 Rule", ruleText1: "The Schengen Visa rule states you can stay a maximum of 90 days in any 180-day period.",
                rollingTitle: "It is a Rolling Window", rollingText: "To check if today is legal, the authorities look at the previous 179 days + today.",
                appHelps: "How this app helps:", appHelp1: "It calculates the \"Rolling Window\" for every single day.",
                appHelp2: "The Check Tool (green line) shows you exactly how many days are used in the 180-day window ending on that specific date.",
                appHelp3: "The Safe Analysis Lane highlights green areas where you could legally start a full 90-day trip without violation.",
                disclaimerTitle: "Disclaimer", disclaimerText: "This tool is for estimation only. Verify with official sources.",
                linkText: "Official EU Visa Calculator",
                usedPrior: "Used (Prior 180d)", safeStay: "Safe Stay", sinceLast: "Since Last", untilNext: "Until Next",
                expireMsg: "days expire during stay"
            },
            ru: {
                code: 'ru-RU', label: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫',
                subtitle: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –®–µ–Ω–≥–µ–Ω–∞",
                todayCount: "–°—á–µ—Ç—á–∏–∫ –¥–Ω–µ–π", statusSafe: "–í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ. –ù–∞—Ä—É—à–µ–Ω–∏–π –Ω–µ—Ç.", statusDanger: "–í–Ω–∏–º–∞–Ω–∏–µ! –ü—Ä–æ—Å—Ä–æ—á–∫–∞",
                addBtn: "–î–æ–±–∞–≤–∏—Ç—å", calendarHeader: "–ö–∞–ª–µ–Ω–¥–∞—Ä—å", delete: "–£–¥–∞–ª–∏—Ç—å",
                overlap: "–î–∞—Ç–∞ –∑–∞–Ω—è—Ç–∞.", overlapRange: "–ù–∞–∫–ª–∞–¥–∫–∞ –¥–∞—Ç!", prompt: "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è",
                prev: "–ü—Ä–µ–¥", next: "–°–ª–µ–¥", today: "–°–µ–≥–æ–¥–Ω—è",
                laneTrips: "–ü–æ–µ–∑–¥–∫–∏", laneAnalysis: "–ê–Ω–∞–ª–∏–∑ (–ó–µ–ª–µ–Ω—ã–π = –°—Ç–∞—Ä—Ç 90–¥)",
                limitLabel: "90 –î–ù–ï–ô (–õ–ò–ú–ò–¢)", graphToday: "–°–ï–ì–û–î–ù–Ø",
                helpTitle: "–ü–æ–º–æ—â—å", tabGuide: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", tabRules: "–ü—Ä–∞–≤–∏–ª–∞",
                interactionTitle: "–û—Å–Ω–æ–≤—ã", legendTitle: "–õ–µ–≥–µ–Ω–¥–∞",
                h_tapEmpty: "–î–≤–æ–π–Ω–æ–π —Ç–∞–ø (–ø—É—Å—Ç–æ)", h_tapEmptyDesc: "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–µ–∑–¥–∫—É.",
                h_tapTrip: "–î–≤–æ–π–Ω–æ–π —Ç–∞–ø (–ø–æ–µ–∑–¥–∫–∞)", h_tapTripDesc: "–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É.",
                h_dragBody: "–¢—è–Ω—É—Ç—å –ø–æ–µ–∑–¥–∫—É", h_dragBodyDesc: "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –¥–∞—Ç—ã –ø–æ–µ–∑–¥–∫–∏.",
                h_dragEdge: "–¢—è–Ω—É—Ç—å –∫—Ä–∞–π", h_dragEdgeDesc: "–ò–∑–º–µ–Ω–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.",
                h_dragTime: "–¢—è–Ω—É—Ç—å —à–∫–∞–ª—É", h_dragTimeDesc: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞.",
                safeTrip: "–ë–µ–∑–æ–ø–∞—Å–Ω–æ", overstayRisk: "–†–∏—Å–∫ (>90 –¥–Ω–µ–π)", safeZone: "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—Ç–∞—Ä—Ç",
                ruleTitle: "–ü—Ä–∞–≤–∏–ª–æ 90/180", ruleText1: "–ú–∞–∫—Å–∏–º—É–º 90 –¥–Ω–µ–π –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è –∑–∞ –ª—é–±–æ–π 180-–¥–Ω–µ–≤–Ω—ã–π –ø–µ—Ä–∏–æ–¥.",
                rollingTitle: "–°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ", rollingText: "–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–µ–¥—ã–¥—É—â–∏–µ 179 –¥–Ω–µ–π + —Å–µ–≥–æ–¥–Ω—è.",
                appHelps: "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:", appHelp1: "–†–∞—Å—á–µ—Ç –æ–∫–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è.",
                appHelp2: "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–Ω–∏ –≤ –æ–∫–Ω–µ 180 –¥–Ω–µ–π.",
                appHelp3: "–ó–µ–ª–µ–Ω–∞—è –ª–∏–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≥–¥–µ –º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –ø–æ–µ–∑–¥–∫—É –Ω–∞ 90 –¥–Ω–µ–π.",
                disclaimerTitle: "–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏", disclaimerText: "–¢–æ–ª—å–∫–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ.",
                linkText: "–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ï–°",
                usedPrior: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ", safeStay: "–ú–æ–∂–Ω–æ –¥–Ω–µ–π", sinceLast: "–° –ø—Ä–æ—à–ª–æ–π", untilNext: "–î–æ —Å–ª–µ–¥—É—é—â–µ–π",
                expireMsg: "–¥–Ω–µ–π —Å–≥–æ—Ä–∞—é—Ç"
            },
            zh: {
                code: 'zh-CN', label: '‰∏≠Êñá', flag: 'üá®üá≥',
                subtitle: "Áî≥Ê†πÂå∫ËÆ°ÁÆóÂô®",
                todayCount: "‰ªäÊó•ÁªüËÆ°", statusSafe: "‰∏ÄÂàáÊ≠£Â∏∏„ÄÇÁ¨¶ÂêàËßÑÂÆö„ÄÇ", statusDanger: "Ë≠¶ÂëäÔºÅË∂ÖÊúü‰∫é",
                addBtn: "Ê∑ªÂä†Ë°åÁ®ã", calendarHeader: "Êó•ÂéÜ", delete: "Âà†Èô§",
                overlap: "Êó•ÊúüÂ∑≤Âç†Áî®", overlapRange: "Êó•ÊúüÈáçÂè†ÔºÅ", prompt: "ÈÄâÊã©ÁªìÊùüÊó•Êúü",
                prev: "‰∏äÈ°µ", next: "‰∏ãÈ°µ", today: "‰ªäÂ§©",
                laneTrips: "Ë°åÁ®ã", laneAnalysis: "ÂÆâÂÖ®ÂàÜÊûê (ÁªøËâ≤ = 90Â§©Ëµ∑ÁÇπ)",
                limitLabel: "90Â§© (‰∏äÈôê)", graphToday: "‰ªäÂ§©",
                helpTitle: "Â∏ÆÂä©", tabGuide: "‰ΩøÁî®ËØ¥Êòé", tabRules: "Áî≥Ê†πËßÑÂàô",
                interactionTitle: "Âü∫Êú¨Êìç‰Ωú", legendTitle: "Âõæ‰æã",
                h_tapEmpty: "ÂèåÂáªÔºàÁ©∫ÁôΩÂ§ÑÔºâ", h_tapEmptyDesc: "ÂàõÂª∫Êñ∞Ë°åÁ®ã„ÄÇ",
                h_tapTrip: "ÂèåÂáªÔºàË°åÁ®ãÔºâ", h_tapTripDesc: "Âà†Èô§Áé∞ÊúâË°åÁ®ã„ÄÇ",
                h_dragBody: "ÊãñÂä®Ë°åÁ®ã", h_dragBodyDesc: "Êï¥‰ΩìÁßªÂä®Ë°åÁ®ãÊó•Êúü„ÄÇ",
                h_dragEdge: "ÊãñÂä®ËæπÁºò", h_dragEdgeDesc: "Ë∞ÉÊï¥Ë°åÁ®ãÊó∂Èïø„ÄÇ",
                h_dragTime: "ÊãñÂä®Êó∂Èó¥ËΩ¥", h_dragTimeDesc: "‰ΩøÁî®Ê£ÄÊü•Â∑•ÂÖ∑Ê®°ÊãüËÆ°ÁÆó„ÄÇ",
                safeTrip: "ÂÆâÂÖ®Ë°åÁ®ã", overstayRisk: "Ë∂ÖÊúüÈ£éÈô© (>90Â§©)", safeZone: "ÂÆâÂÖ®Âá∫ÂèëÂå∫ (ÂèØÂÅúÁïô90Â§©)",
                ruleTitle: "90/180 ËßÑÂàô", ruleText1: "Âú®‰ªª‰Ωï180Â§©ÂÜÖÊúÄÂ§öÂÅúÁïô90Â§©„ÄÇ",
                rollingTitle: "ÊªöÂä®Á™óÂè£", rollingText: "ÂΩìÂ±Ä‰ºöÊü•ÁúãËøáÂéª179Â§©Âä†‰∏ä‰ªäÂ§©ÁöÑÊÉÖÂÜµ„ÄÇ",
                appHelps: "Â∫îÁî®ÂäüËÉΩÔºö", appHelp1: "ËÆ°ÁÆóÊØè‰∏ÄÂ§©ÁöÑÊªöÂä®Á™óÂè£„ÄÇ",
                appHelp2: "Ê£ÄÊü•Â∑•ÂÖ∑ÊòæÁ§∫ÁâπÂÆöÊó•Êúü180Â§©Á™óÂè£ÂÜÖÁöÑÂ∑≤Áî®Â§©Êï∞„ÄÇ",
                appHelp3: "ÂÆâÂÖ®ÂàÜÊûêÈÄöÈÅìÊòæÁ§∫ÂèØ‰ª•ÂêàÊ≥ïÂºÄÂßã90Â§©Ë°åÁ®ãÁöÑÊó∂Èó¥ÊÆµ„ÄÇ",
                disclaimerTitle: "ÂÖçË¥£Â£∞Êòé", disclaimerText: "‰ªÖ‰æõ‰º∞ÁÆó„ÄÇËØ∑‰ª•ÂÆòÊñπ‰∏∫ÂáÜ„ÄÇ",
                linkText: "Ê¨ßÁõüÂÆòÊñπËÆ°ÁÆóÂô®",
                usedPrior: "Â∑≤Áî® (Ââç180Â§©)", safeStay: "ÂèØÂÅúÁïô", sinceLast: "Ë∑ù‰∏äÊ¨°", untilNext: "Ë∑ù‰∏ãÊ¨°",
                expireMsg: "Â§©ËøáÊúü"
            }
        };

        // --- ICONS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const d = {
                Calendar: "M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm-3-1v2M8 3v2M3 10h18",
                Trash2: "M3 6h18M19 6v14c0 1 0 2-2 2H7c-2 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6",
                ChevronLeft: "m15 18-6-6 6-6",
                ChevronRight: "m9 18 6-6-6-6",
                SkipBack: "M19 20L9 12l10-8v16zM5 19V5h2v14H5z",
                SkipForward: "M5 4l10 8-10 8V4zM19 5v14h-2V5h2z",
                Info: "M12 16v-4M12 8h.01M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Z",
                AlertCircle: "M12 8v4M12 16h.01M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10Z",
                HelpCircle: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3m.08 4h.01",
                X: "M18 6L6 18M6 6l12 12",
                Target: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4z",
                Globe: "M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8ZM12 4a8 8 0 0 0-8 8c0 .36.02.71.06 1.06h15.88A8.03 8.03 0 0 0 12 4Zm-8 8a7.95 7.95 0 0 0 1.22 4.12L12 12l-4.27-4.12A7.93 7.93 0 0 0 4 12Zm8 8a7.95 7.95 0 0 0 4.12-1.22L12 12l4.12 4.27A7.95 7.95 0 0 0 12 20Z",
                ChevronDown: "m6 9 6 6 6-6"
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d[name]||""} /></svg>;
        };

        // --- UTILS ---
        const MS_PER_DAY = 86400000;
        const toUTC = (d) => Date.UTC(d.getFullYear(), d.getMonth(), d.getDate());
        const addDays = (ts, d) => ts + d * MS_PER_DAY;
        const diffDays = (t1, t2) => Math.round((t1 - t2) / MS_PER_DAY);
        const formatShortDate = (ts, locale = 'en-GB') => new Date(ts).toLocaleDateString(locale, { day: 'numeric', month: 'short', timeZone: 'UTC' });

        // --- COMPONENTS ---
        const HelpModal = ({ isOpen, onClose, t }) => {
            const [tab, setTab] = useState('guide'); 

            return (
                <div className={`fixed inset-0 z-50 transition-all duration-300 ${isOpen ? 'pointer-events-auto bg-black/20' : 'pointer-events-none bg-black/0'}`}>
                    <div className={`absolute right-0 top-0 bottom-0 w-full max-w-md bg-white shadow-2xl transition-transform duration-300 transform ${isOpen ? 'translate-x-0' : 'translate-x-full'} flex flex-col`}>
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h2 className="font-bold text-lg">{t.helpTitle}</h2>
                            <button onClick={onClose} className="p-2 bg-slate-200 rounded-full hover:bg-slate-300"><Icon name="X" size={18}/></button>
                        </div>
                        
                        <div className="flex border-b">
                            <button onClick={()=>setTab('guide')} className={`flex-1 p-3 text-sm font-bold ${tab==='guide'?'text-blue-600 border-b-2 border-blue-600':'text-slate-500'}`}>{t.tabGuide}</button>
                            <button onClick={()=>setTab('rules')} className={`flex-1 p-3 text-sm font-bold ${tab==='rules'?'text-blue-600 border-b-2 border-blue-600':'text-slate-500'}`}>{t.tabRules}</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            {tab === 'guide' ? (
                                <>
                                    <section>
                                        <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Icon name="Target" size={16}/> {t.interactionTitle}</h3>
                                        <ul className="space-y-3 text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border">
                                            <li className="flex gap-2">üëÜ <strong>{t.h_tapEmpty}:</strong> {t.h_tapEmptyDesc}</li>
                                            <li className="flex gap-2">üóëÔ∏è <strong>{t.h_tapTrip}:</strong> {t.h_tapTripDesc}</li>
                                            <li className="flex gap-2">‚ÜîÔ∏è <strong>{t.h_dragBody}:</strong> {t.h_dragBodyDesc}</li>
                                            <li className="flex gap-2">‚û°Ô∏è <strong>{t.h_dragEdge}:</strong> {t.h_dragEdgeDesc}</li>
                                            <li className="flex gap-2">üîç <strong>{t.h_dragTime}:</strong> {t.h_dragTimeDesc}</li>
                                        </ul>
                                    </section>
                                    <section>
                                        <h3 className="font-bold text-slate-800 mb-2">{t.legendTitle}</h3>
                                        <div className="space-y-2 text-xs font-bold">
                                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded bg-green-500"></div> {t.safeTrip}</div>
                                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded bg-red-500"></div> {t.overstayRisk}</div>
                                            <div className="flex items-center gap-2"><div className="w-4 h-4 rounded bg-green-100 border border-green-200"></div> {t.safeZone}</div>
                                        </div>
                                    </section>
                                </>
                            ) : (
                                <>
                                    <section>
                                        <h3 className="font-bold text-slate-800 mb-2 text-lg">{t.ruleTitle}</h3>
                                        <p className="text-sm text-slate-600 leading-relaxed mb-4">{t.ruleText1}</p>
                                        
                                        <div className="bg-blue-50 p-3 rounded border border-blue-100 mb-4">
                                            <h4 className="font-bold text-blue-800 text-sm mb-1">{t.rollingTitle}</h4>
                                            <p className="text-xs text-blue-700">{t.rollingText}</p>
                                        </div>
                                        <h4 className="font-bold text-sm mb-2">{t.appHelps}</h4>
                                        <ul className="list-disc pl-4 text-sm text-slate-600 space-y-1">
                                            <li>{t.appHelp1}</li>
                                            <li>{t.appHelp2}</li>
                                            <li>{t.appHelp3}</li>
                                        </ul>

                                        <div className="mt-6 p-3 bg-amber-50 border border-amber-200 rounded text-xs text-amber-800">
                                            <strong className="block mb-1 flex items-center gap-1"><Icon name="AlertCircle" size={12}/> {t.disclaimerTitle}</strong>
                                            {t.disclaimerText}
                                            <br/><br/>
                                            <a href="https://ec.europa.eu/assets/home/visa-calculator/calculator.htm" target="_blank" className="underline text-amber-900 font-bold">{t.linkText}</a>
                                        </div>
                                    </section>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            )
        }

        const LanguageMenu = ({ isOpen, current, onSelect, onClose }) => {
            if(!isOpen) return null;
            return (
                <div className="absolute top-12 right-0 bg-white rounded-lg shadow-xl border border-slate-200 py-2 w-48 z-50 animate-in fade-in zoom-in duration-200 overflow-hidden">
                    {Object.entries(TRANSLATIONS).map(([key, data]) => (
                        <button key={key} onClick={() => { onSelect(key); onClose(); }} className={`w-full text-left px-4 py-3 text-sm flex items-center gap-3 hover:bg-slate-50 border-b border-slate-50 last:border-0 ${current===key ? 'font-bold text-blue-600 bg-blue-50' : 'text-slate-700'}`}>
                            <span className="text-xl">{data.flag}</span>
                            <span>{data.label}</span>
                        </button>
                    ))}
                </div>
            );
        };

        const CalendarWidget = ({ trips, onAddTrip, onDeleteTrip, closeMobile, t, locale }) => {
            const [curr, setCurr] = useState(toUTC(new Date()));
            const [selStart, setSelStart] = useState(null);
            const [error, setError] = useState(null);

            const days = useMemo(() => {
                const d = new Date(curr);
                const y = d.getUTCFullYear(), m = d.getUTCMonth();
                const total = new Date(Date.UTC(y, m + 1, 0)).getUTCDate();
                const first = new Date(Date.UTC(y, m, 1)).getUTCDay();
                const arr = Array((first===0?6:first-1)).fill(null);
                for(let i=1; i<=total; i++) arr.push(Date.UTC(y, m, i));
                return arr;
            }, [curr]);

            const isOverlap = (s, e) => trips.some(t => Math.max(s, t.start) <= Math.min(e, t.end));

            const clickDay = (date) => {
                if(!date) return;
                setError(null);
                if(selStart === null) {
                    if(isOverlap(date, date)) return setError(t.overlap);
                    setSelStart(date);
                } else {
                    let s = selStart, e = date;
                    if(e < s) [s, e] = [e, s];
                    if(isOverlap(s, e)) { setError(t.overlapRange); setSelStart(null); return; }
                    onAddTrip(s, e);
                    setSelStart(null);
                    closeMobile();
                }
            };

            return (
                <div className="h-full flex flex-col">
                    <div className="flex justify-between mb-4 items-center">
                        <button onClick={()=>{const d=new Date(curr);d.setUTCMonth(d.getUTCMonth()-1);setCurr(d.getTime())}} className="p-2 bg-slate-100 rounded-full"><Icon name="ChevronLeft"/></button>
                        <span className="font-bold">{new Date(curr).toLocaleDateString(locale,{month:'long',year:'numeric',timeZone:'UTC'})}</span>
                        <button onClick={()=>{const d=new Date(curr);d.setUTCMonth(d.getUTCMonth()+1);setCurr(d.getTime())}} className="p-2 bg-slate-100 rounded-full"><Icon name="ChevronRight"/></button>
                    </div>
                    <div className="grid grid-cols-7 text-center text-xs text-slate-400 mb-2 font-bold"><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div><div>S</div></div>
                    <div className="grid grid-cols-7 gap-1">
                        {days.map((d, i) => {
                            if(!d) return <div key={i} className="h-9"/>;
                            const inTrip = trips.some(t => d>=t.start && d<=t.end);
                            const isSel = d===selStart;
                            return <button key={i} onClick={()=>clickDay(d)} className={`h-9 rounded text-xs font-bold ${inTrip?'bg-blue-100 text-blue-700':isSel?'bg-green-500 text-white':'hover:bg-slate-100'}`}>{new Date(d).getUTCDate()}</button>
                        })}
                    </div>
                    <div className="mt-2 text-center h-6 text-xs font-bold text-red-500">{error || (selStart ? t.prompt : "")}</div>
                    <div className="flex-1 overflow-y-auto mt-2 border-t pt-2">
                        {trips.sort((a,b)=>a.start-b.start).map(t => (
                            <div key={t.id} className="flex justify-between items-center bg-slate-50 p-2 mb-2 rounded border">
                                <div className="text-xs font-bold">{formatShortDate(t.start, locale)} - {formatShortDate(t.end, locale)} <span className="font-normal text-slate-400">({diffDays(t.end,t.start)+1}d)</span></div>
                                <button onClick={()=>onDeleteTrip(t.id)} className="text-slate-400 hover:text-red-500 flex items-center gap-1"><span className="text-[10px] uppercase">{t.delete}</span><Icon name="Trash2" size={16}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            // State
            const [trips, setTrips] = useState(() => {
                try { return JSON.parse(localStorage.getItem('schmengen_trips')) || []; } catch (e) { return []; }
            });

            const [viewStart, setViewStart] = useState(toUTC(new Date()) - (60 * MS_PER_DAY));
            const [dragState, setDragState] = useState(null);
            const [checkDate, setCheckDate] = useState(null); 
            const [showMobileCalendar, setShowMobileCalendar] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [showLangMenu, setShowLangMenu] = useState(false);
            const [langKey, setLangKey] = useState(() => localStorage.getItem('schmengen_lang') || 'en');
            
            const t = TRANSLATIONS[langKey] || TRANSLATIONS['en'];
            const svgRef = useRef(null);
            const lastTapRef = useRef({ time: 0, x: 0, y: 0 });
            
            // --- EFFECTS ---
            useEffect(() => { localStorage.setItem('schmengen_trips', JSON.stringify(trips)); }, [trips]);
            useEffect(() => { localStorage.setItem('schmengen_lang', langKey); }, [langKey]);

            // Close menu on click outside
            useEffect(() => {
                const close = () => setShowLangMenu(false);
                if(showLangMenu) window.addEventListener('click', close);
                return () => window.removeEventListener('click', close);
            }, [showLangMenu]);

            // Constants
            const PX_PER_DAY = 14;
            const LANE_SPLIT_Y = 220;
            const TOTAL_HEIGHT = 350;
            const GRAPH_H = TOTAL_HEIGHT - LANE_SPLIT_Y - 20;

            // Logic
            const calcUsage = (target, currentTrips) => {
                const winStart = target - (179 * MS_PER_DAY);
                let used = 0;
                currentTrips.forEach(t => {
                    const s = Math.max(t.start, winStart), e = Math.min(t.end, target);
                    if(s <= e) used += diffDays(e, s) + 1;
                });
                return used;
            };

            const calcSafe = (arrDate, tripList) => {
                const tList = tripList || trips;
                for (let k = 1; k <= 90; k++) {
                    const testDate = arrDate + ((k - 1) * MS_PER_DAY);
                    if (tList.some(t => testDate >= t.start && testDate <= t.end)) return k - 1;

                    const winStart = testDate - (179 * MS_PER_DAY);
                    let daysInWindow = 0;
                    tList.forEach(t => {
                        const s = Math.max(t.start, winStart);
                        const e = Math.min(t.end, testDate);
                        if (s <= e && t.end < arrDate) daysInWindow += diffDays(e, s) + 1;
                    });
                    daysInWindow += k; 

                    if (daysInWindow > 90) return k - 1;
                }
                return 90;
            };

            const dangerTripIds = useMemo(() => {
                const ids = new Set();
                trips.forEach(t => {
                    for(let d = t.start; d <= t.end; d += MS_PER_DAY) {
                        if(calcUsage(d, trips) > 90) { ids.add(t.id); break; }
                    }
                });
                return ids;
            }, [trips]);

            const getGapStats = (date, tripList) => {
                const tList = tripList || trips;
                const past = tList.filter(t => t.end < date).sort((a,b) => b.end - a.end)[0];
                const since = past ? diffDays(date, past.end) - 1 : null;
                const future = tList.filter(t => t.start > date).sort((a,b) => a.start - b.start)[0];
                const until = future ? diffDays(future.start, date) - 1 : null;
                return { since, until };
            };

            const getExpiringDays = (date, duration, tripList) => {
                const tList = tripList || trips;
                const stayEnd = date + ((duration - 1) * MS_PER_DAY);
                const startWindowStart = date - (179 * MS_PER_DAY);
                const endWindowStart = stayEnd - (179 * MS_PER_DAY);
                let expiring = 0;
                tList.forEach(t => {
                    if (t.end < date) { 
                        const s1 = Math.max(t.start, startWindowStart);
                        const e1 = Math.min(t.end, date);
                        const usedAtStart = (s1 <= e1) ? diffDays(e1, s1) + 1 : 0;
                        const s2 = Math.max(t.start, endWindowStart);
                        const e2 = Math.min(t.end, stayEnd);
                        const usedAtEnd = (s2 <= e2) ? diffDays(e2, s2) + 1 : 0;
                        if(usedAtStart > usedAtEnd) expiring += (usedAtStart - usedAtEnd);
                    }
                });
                return expiring;
            };

            const handleAddTrip = (s, e) => setTrips(prev => [...prev, { id: Math.random().toString(36).substr(2,9), start:s, end:e }]);
            const removeTrip = (id) => setTrips(prev => prev.filter(t => t.id !== id));
            
            const currentUsage = useMemo(() => calcUsage(toUTC(new Date()), trips), [trips]);
            const violation = useMemo(() => {
                for(let i=0; i<730; i++) {
                    const d = viewStart + (i*MS_PER_DAY);
                    if(calcUsage(d, trips) > 90) return { d, u: calcUsage(d, trips) };
                }
                return null;
            }, [trips, viewStart]);

            // Visual helpers
            const getX = (d) => diffDays(d, viewStart) * PX_PER_DAY;
            const getW = (s, e) => (diffDays(e, s) + 1) * PX_PER_DAY;

            // --- GRID GENERATION ---
            const months = useMemo(() => {
                const arr = [];
                const startM = new Date(viewStart); 
                startM.setUTCDate(1); 
                startM.setUTCHours(0, 0, 0, 0);
                startM.setUTCMonth(startM.getUTCMonth() - 2);
                
                for(let i=0; i<36; i++){
                    const d = new Date(startM); 
                    d.setUTCMonth(d.getUTCMonth() + i);
                    const next = new Date(d); 
                    next.setUTCMonth(next.getUTCMonth() + 1);
                    const monthStart = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1);
                    const nextMonthStart = Date.UTC(next.getUTCFullYear(), next.getUTCMonth(), 1);
                    const w = diffDays(nextMonthStart, monthStart) * PX_PER_DAY;
                    arr.push({ d: monthStart, w, label: d.toLocaleDateString(t.code, {month:'short', year:'2-digit', timeZone:'UTC'}), isEven: i%2===0 });
                }
                return arr;
            }, [viewStart, t.code]);

            const weeks = useMemo(() => {
                const arr = [];
                const d = new Date(viewStart - (20 * MS_PER_DAY));
                const day = d.getUTCDay();
                const diff = d.getUTCDate() - day + (day === 0 ? -6 : 1);
                d.setUTCDate(diff);
                for(let i=0; i<100; i++){
                    const wDate = new Date(d); wDate.setUTCDate(wDate.getUTCDate() + (i * 7));
                    arr.push(toUTC(wDate));
                }
                return arr;
            }, [viewStart]);

            const greenZones = useMemo(() => {
                const zones = [];
                const startDraw = viewStart - (10 * MS_PER_DAY);
                const steps = Math.ceil(window.innerWidth / PX_PER_DAY) + 20;
                let currentZoneStart = null;
                for(let i=0; i<steps; i++) {
                    const d = startDraw + (i * MS_PER_DAY);
                    const isSafe90 = calcSafe(d, trips) === 90;
                    if(isSafe90 && currentZoneStart === null) {
                        currentZoneStart = d;
                    } else if (!isSafe90 && currentZoneStart !== null) {
                        zones.push({ start: currentZoneStart, end: d - MS_PER_DAY });
                        currentZoneStart = null;
                    }
                }
                if(currentZoneStart !== null) {
                    zones.push({ start: currentZoneStart, end: startDraw + (steps * MS_PER_DAY) });
                }
                return zones;
            }, [trips, viewStart]);

            const graphPath = useMemo(() => {
                if(trips.length === 0) return `M 0 ${TOTAL_HEIGHT - 5} L ${window.innerWidth} ${TOTAL_HEIGHT - 5}`;
                let path = "";
                const startDraw = viewStart - (20 * MS_PER_DAY);
                const steps = Math.ceil(window.innerWidth / PX_PER_DAY) + 40;
                for(let i=0; i<steps; i++) {
                    const d = startDraw + (i * MS_PER_DAY);
                    const u = calcUsage(d, trips);
                    const x = (diffDays(d, viewStart) * PX_PER_DAY);
                    const yRatio = Math.min(u, 90) / 90;
                    const y = TOTAL_HEIGHT - 5 - (yRatio * GRAPH_H); 
                    path += `${i===0?'M':'L'} ${x} ${y} `;
                }
                return path;
            }, [trips, viewStart]);

            // --- GESTURE ENGINE ---
            const onPointerDown = (e, type, id) => {
                const now = Date.now();
                const cx = e.clientX;
                const cy = e.clientY;
                const last = lastTapRef.current;
                const dist = Math.hypot(cx - last.x, cy - last.y);

                // DOUBLE TAP
                if (now - last.time < 300 && dist < 40) {
                    if (type === 'BG') handleBgDoubleTap(cx, cy);
                    else if (type === 'TRIP') removeTrip(id);
                    lastTapRef.current = { time: 0, x: 0, y: 0 };
                    return; 
                }

                // SINGLE TAP
                lastTapRef.current = { time: now, x: cx, y: cy };

                if(type === 'TRIP' || type === 'RESIZE') {
                    if (e.stopPropagation) e.stopPropagation();
                    const t = trips.find(x => x.id === id);
                    setDragState({ type: type === 'TRIP' ? 'TRIP_MOVE' : 'TRIP_RESIZE', id, startX: cx, origS: t.start, origE: t.end });
                    setCheckDate(null);
                } else if(svgRef.current) {
                    const rect = svgRef.current.getBoundingClientRect();
                    const y = cy - rect.top;
                    if(y > LANE_SPLIT_Y) {
                        const d = viewStart + (Math.round((cx - rect.left) / PX_PER_DAY) * MS_PER_DAY);
                        setCheckDate(d);
                        setDragState({ type: 'CHECK_TOOL', startX: cx });
                    } else {
                        // STANDARD SCROLL
                        setDragState({ type: 'SCROLL', startX: cx, origView: viewStart });
                    }
                }
            };

            const handleBgDoubleTap = (cx, cy) => {
                if(svgRef.current) {
                    const rect = svgRef.current.getBoundingClientRect();
                    const y = cy - rect.top;
                    if(y < LANE_SPLIT_Y) {
                        const d = viewStart + (Math.floor((cx - rect.left) / PX_PER_DAY) * MS_PER_DAY);
                        if (trips.some(t => d >= t.start && d <= t.end)) return; 
                        const idealEnd = d + (6 * MS_PER_DAY);
                        const collidingTrip = trips.filter(t => t.start > d && t.start <= idealEnd).sort((a,b) => a.start - b.start)[0];
                        let finalEnd = idealEnd;
                        if (collidingTrip) finalEnd = collidingTrip.start - MS_PER_DAY;
                        if(finalEnd < d) finalEnd = d;
                        handleAddTrip(d, finalEnd);
                    }
                }
            }

            const onPointerMove = (e) => {
                if(!dragState) return;
                const cx = e.clientX;
                if(e.cancelable) e.preventDefault();

                if(dragState.type === 'SCROLL') {
                    const diff = Math.round((cx - dragState.startX) / PX_PER_DAY);
                    setViewStart(dragState.origView - (diff * MS_PER_DAY));
                    return;
                }
                if(dragState.type === 'CHECK_TOOL') {
                    const rect = svgRef.current.getBoundingClientRect();
                    const d = viewStart + (Math.round((cx - rect.left) / PX_PER_DAY) * MS_PER_DAY);
                    setCheckDate(d);
                    return;
                }

                const diff = Math.round((cx - dragState.startX) / PX_PER_DAY);
                setTrips(prev => {
                    const t = prev.find(x => x.id === dragState.id);
                    if(!t) return prev;
                    const others = prev.filter(x => x.id !== dragState.id);
                    let nt = { ...t };
                    if(dragState.type === 'TRIP_MOVE') {
                        const dur = diffDays(dragState.origE, dragState.origS);
                        nt.start = addDays(dragState.origS, diff);
                        nt.end = addDays(nt.start, dur);
                        if(!others.some(o => Math.max(nt.start, o.start) <= Math.min(nt.end, o.end))) return prev.map(x => x.id===nt.id?nt:x);
                    } else {
                        nt.end = addDays(dragState.origE, diff);
                        if(nt.end < nt.start) nt.end = nt.start;
                        if(!others.some(o => Math.max(nt.start, o.start) <= Math.min(nt.end, o.end))) return prev.map(x => x.id===nt.id?nt:x);
                    }
                    return prev;
                });
            };

            const onPointerUp = () => setDragState(null);

            const jump = (dir) => {
                if(dir === 'today') {
                    const daysOnScreen = window.innerWidth / PX_PER_DAY;
                    const daysShift = Math.floor(daysOnScreen / 2);
                    setViewStart(toUTC(new Date()) - (daysShift * MS_PER_DAY));
                    return;
                }
                const sorted = [...trips].sort((a,b) => a.start - b.start);
                if(!sorted.length) return;
                const daysOnScreen = window.innerWidth / PX_PER_DAY;
                const centerDate = viewStart + ((daysOnScreen / 2) * MS_PER_DAY);
                const buffer = MS_PER_DAY; 
                let target;
                if(dir === 'n') {
                    target = sorted.find(x => x.start > centerDate + buffer);
                    if(!target) target = sorted[0];
                } else {
                    target = [...sorted].reverse().find(x => x.end < centerDate - buffer);
                    if(!target) target = sorted[sorted.length - 1];
                }
                if(target) {
                    const tripDuration = diffDays(target.end, target.start);
                    const tripCenter = target.start + ((tripDuration / 2) * MS_PER_DAY);
                    const daysShift = Math.floor(daysOnScreen / 2);
                    const newStart = tripCenter - (daysShift * MS_PER_DAY);
                    setViewStart(newStart);
                }
            };

            useEffect(() => {
                window.addEventListener('pointerup', onPointerUp); 
                window.addEventListener('pointermove', onPointerMove);
                return () => {
                     window.removeEventListener('pointerup', onPointerUp); 
                     window.removeEventListener('pointermove', onPointerMove);
                };
            }, [dragState, viewStart]);

            const analysisTrips = useMemo(() => {
                if (!checkDate) return trips;
                const processed = [];
                trips.forEach(t => {
                    if (checkDate > t.start && checkDate < t.end) {
                        processed.push({ ...t, id: t.id + '-a', end: checkDate });
                        processed.push({ ...t, id: t.id + '-b', start: checkDate + MS_PER_DAY });
                    } else {
                        processed.push(t);
                    }
                });
                return processed;
            }, [trips, checkDate]);

            const checkStats = useMemo(() => {
                if(!checkDate) return null;
                
                // --- FIX 1: REMOVED "- MS_PER_DAY" ---
                // Previously, this subtracted 1 day, calculating usage for the window 
                // ending yesterday. We must pass 'checkDate' directly to include 
                // the selected day in the 180-day count.
                const u = calcUsage(checkDate, analysisTrips); 
                
                // CalcSafe already correctly uses the array date as the start point
                const s = calcSafe(checkDate, analysisTrips);
                
                return { 
                    u: u, 
                    s: s, 
                    gap: getGapStats(checkDate, analysisTrips), 
                    expiring: getExpiringDays(checkDate, s, analysisTrips) 
                };
            }, [checkDate, analysisTrips]);

            return (
                <div className="flex flex-col h-full bg-slate-50 select-none font-sans text-slate-800">
                    <HelpModal isOpen={showHelp} onClose={()=>setShowHelp(false)} t={t} />

                    {/* HEADER */}
                    <div className="bg-white border-b p-3 flex justify-between items-center shadow-sm z-20 relative">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl select-none">ü•Ø</span>
                            <div className="leading-tight">
                                <div className="font-bold">Schengen-Schmengen</div>
                                <div className="text-[10px] text-slate-500 uppercase tracking-wider">{t.subtitle}</div>
                            </div>
                        </div>
                        <div className="flex gap-2 items-center">
                            <div className="relative">
                                <button onClick={(e) => { e.stopPropagation(); setShowLangMenu(!showLangMenu); }} className="flex items-center gap-1 px-2 py-1 bg-slate-100 rounded-full text-xs font-bold hover:bg-slate-200 border shadow-sm">
                                    <span className="text-lg leading-none">{t.flag}</span>
                                    <Icon name="ChevronDown" size={12} className="text-slate-400"/>
                                </button>
                                <LanguageMenu isOpen={showLangMenu} current={langKey} onSelect={setLangKey} onClose={()=>setShowLangMenu(false)} />
                            </div>
                            
                            <button onClick={()=>setShowHelp(true)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-slate-100 rounded-full"><Icon name="HelpCircle"/></button>
                            
                            <div className="text-right ml-2">
                                <div className="text-[10px] uppercase text-slate-400 font-bold">{t.todayCount}</div>
                                <div className={`text-lg font-bold leading-none ${currentUsage>90?'text-red-600':''}`}>{currentUsage}/90</div>
                            </div>
                        </div>
                    </div>

                    {/* CONTROLS */}
                    <div className="bg-white p-2 border-b flex flex-col gap-2 z-10">
                        <div className={`px-3 py-2 rounded-lg text-xs flex items-center gap-2 border ${violation ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800'}`}>
                            <Icon name={violation ? 'AlertCircle' : 'Info'} className={violation ? 'text-red-600' : 'text-green-600'}/>
                            {violation ? <span><strong>{t.statusDanger}</strong> {formatShortDate(violation.d, t.code)}</span> : <span>{t.statusSafe}</span>}
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>jump('p')} className="flex-1 py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 border active:bg-slate-200 flex justify-center items-center gap-1"><Icon name="SkipBack" size={14}/> {t.prev}</button>
                            <button onClick={()=>jump('today')} className="flex-1 py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 border active:bg-slate-200 flex justify-center items-center gap-1">{t.today}</button>
                            <button onClick={()=>jump('n')} className="flex-1 py-2 bg-slate-100 rounded-lg text-xs font-bold text-slate-600 border active:bg-slate-200 flex justify-center items-center gap-1">{t.next} <Icon name="SkipForward" size={14}/></button>
                            <button onClick={()=>setShowMobileCalendar(true)} className="flex-[2] py-2 bg-blue-400 text-white hover:bg-blue-500 rounded-lg text-xs font-bold shadow active:bg-blue-600 flex justify-center items-center gap-1"><Icon name="Calendar" size={14}/> {t.addBtn}</button>
                        </div>
                    </div>

                    {/* CANVAS */}
                    <div className="flex-1 relative overflow-hidden bg-slate-100">
                        {/* Modal */}
                        <div className={`absolute inset-0 bg-white z-50 transition-transform duration-300 ${showMobileCalendar?'translate-y-0':'translate-y-full'}`}>
                            <div className="p-4 h-full flex flex-col">
                                <div className="flex justify-between mb-2"><h2 className="font-bold text-lg">{t.calendarHeader}</h2><button onClick={()=>setShowMobileCalendar(false)} className="text-blue-600 font-bold">Close</button></div>
                                <CalendarWidget trips={trips} onAddTrip={handleAddTrip} onDeleteTrip={removeTrip} closeMobile={()=>setShowMobileCalendar(false)} t={t} locale={t.code} />
                            </div>
                        </div>

                        {/* SVG */}
                        <div className="absolute inset-0 touch-none" ref={svgRef} onPointerDown={(e)=>onPointerDown(e, 'BG')}>
                            <svg width="100%" height="100%">
                                {/* 1. BACKGROUND LANES */}
                                <rect x="-5000" y="0" width="10000" height={LANE_SPLIT_Y} fill="#ffffff" />
                                <rect x="-5000" y={LANE_SPLIT_Y} width="10000" height={TOTAL_HEIGHT - LANE_SPLIT_Y} fill="#f8fafc" />

                                {/* 2. GREEN SAFE ZONES (Analysis Lane -> EXTENDED) */}
                                {greenZones.map((z, i) => {
                                    const x = getX(z.start);
                                    const w = getW(z.start, z.end);
                                    return (
                                        <rect key={`g-${i}`} x={x} y={0} width={w} height={TOTAL_HEIGHT} fill="#dcfce7" />
                                    );
                                })}

                                {/* 3. GRID LINES & MONTHS */}
                                {months.map((m, i) => {
                                    const x = getX(m.d);
                                    if(x < -500 || x > 3000) return null;
                                    return (
                                        <g key={i} transform={`translate(${x},0)`}>
                                            <line x1="0" y1="0" x2="0" y2={TOTAL_HEIGHT} stroke="#e2e8f0" strokeWidth="2" />
                                            <text x="5" y="20" className="text-xs font-black fill-slate-400 uppercase tracking-widest">{m.label}</text>
                                        </g>
                                    );
                                })}
                                {weeks.map((w, i) => {
                                    const x = getX(w);
                                    if(x < -100 || x > 3000) return null;
                                    const dateNum = new Date(w).getUTCDate();
                                    return (
                                        <g key={i} transform={`translate(${x},0)`}>
                                            <line x1="0" y1="30" x2="0" y2={LANE_SPLIT_Y} stroke="#f1f5f9" strokeDasharray="2,2" />
                                            <text x="3" y="42" className="text-[8px] fill-slate-300 font-bold">{dateNum}</text>
                                        </g>
                                    );
                                })}

                                {/* 4. LANE LABELS */}
                                <line x1="-5000" y1={LANE_SPLIT_Y} x2="5000" y2={LANE_SPLIT_Y} stroke="#cbd5e1" strokeWidth="1" />
                                <text x="10" y={LANE_SPLIT_Y - 10} className="text-[9px] font-bold fill-slate-400 uppercase">{t.laneTrips}</text>
                                <text x="10" y={LANE_SPLIT_Y + 15} className="text-[9px] font-bold fill-green-700 uppercase">{t.laneAnalysis}</text>

                                {/* 5. ANALYTICS GRAPH */}
                                <path d={graphPath} fill="none" stroke="#3b82f6" strokeWidth="2" />
                                <line x1="-5000" y1={TOTAL_HEIGHT - 5 - GRAPH_H} x2="5000" y2={TOTAL_HEIGHT - 5 - GRAPH_H} stroke="#93c5fd" strokeDasharray="4,4" />
                                <text x={window.innerWidth - 70} y={TOTAL_HEIGHT - 8 - GRAPH_H} className="text-[8px] fill-blue-600 font-bold bg-white">{t.limitLabel}</text>

                                {/* 6. TRIPS */}
                                {trips.map(t => {
                                    const x = getX(t.start), w = getW(t.start, t.end);
                                    const isDrag = dragState?.id === t.id;
                                    const isDanger = dangerTripIds.has(t.id);
                                    if(x + w < -100 || x > window.innerWidth + 100) return null;
                                    
                                    // COLORS CHANGED: Green/Red instead of Blue/Red
                                    const fillColor = isDanger ? '#ef4444' : (isDrag ? '#16a34a' : '#22c55e');
                                    const strokeColor = isDanger ? '#b91c1c' : 'white';

                                    return (
                                        <g key={t.id} transform={`translate(${x}, 80)`}>
                                            <rect width={w} height="40" rx="6" fill={fillColor} stroke={strokeColor} strokeWidth="2" onPointerDown={(e)=>onPointerDown(e,'TRIP',t.id)}/>
                                            <g transform="translate(4, 12)" opacity="0.5" className="pointer-events-none"><line x1="0" y1="0" x2="0" y2="16" stroke="white" strokeWidth="2"/><line x1="3" y1="0" x2="3" y2="16" stroke="white" strokeWidth="2"/></g>
                                            <g transform={`translate(${w-20}, 0)`} onPointerDown={(e)=>onPointerDown(e,'RESIZE',t.id)}><rect width="20" height="40" rx="4" fill="rgba(0,0,0,0.1)" /><path d="M8 12l4 8l-4 8" stroke="white" strokeWidth="2" fill="none" opacity="0.8"/></g>
                                            {w>35 && (<g className="pointer-events-none"><text x={w/2} y="16" textAnchor="middle" className="text-[10px] font-bold fill-white">{diffDays(t.end, t.start)+1}d</text><text x={w/2} y="28" textAnchor="middle" className="text-[8px] fill-blue-100">{formatShortDate(t.start, t.code)} - {formatShortDate(t.end, t.code)}</text></g>)}
                                        </g>
                                    )
                                })}

                                {/* 7. TODAY LINE */}
                                <g transform={`translate(${getX(toUTC(new Date()))},0)`}>
                                    <line y2={TOTAL_HEIGHT} stroke="#fbbf24" strokeWidth="2" strokeDasharray="4,4"/>
                                    <text x="4" y="12" className="text-[9px] font-bold fill-amber-500">{t.graphToday}</text>
                                </g>

                                {/* 8. CHECK TOOL */}
                                {checkDate && (
                                    <g transform={`translate(${getX(checkDate)},0)`}>
                                        <line y1={0} y2={TOTAL_HEIGHT} stroke="#16a34a" strokeWidth="2"/>
                                        <circle cy={LANE_SPLIT_Y + ((1 - (Math.min(checkStats.u,90)/90)) * GRAPH_H) + 15} r="4" fill="#15803d" stroke="white"/>
                                        
                                        <g transform={`translate(${getX(checkDate) > window.innerWidth/2 ? -165 : 10}, ${LANE_SPLIT_Y+20})`}>
                                            <rect width="155" height="110" rx="8" fill="white" stroke="#cbd5e1" className="shadow-xl"/>
                                            <text x="10" y="18" className="text-[10px] font-bold fill-slate-400 uppercase">{formatShortDate(checkDate, t.code)}</text>
                                            <line x1="10" y1="26" x2="145" y2="26" stroke="#e2e8f0"/>
                                            
                                            <text x="10" y="42" className="text-[10px] fill-slate-500">{t.usedPrior}:</text>
                                            <text x="145" y="42" textAnchor="end" className="text-xs font-bold fill-slate-700">{checkStats.u}d</text>
                                            
                                            <text x="10" y="56" className="text-[10px] fill-slate-500">{t.safeStay}:</text>
                                            <text x="145" y="56" textAnchor="end" className={`text-xs font-bold ${checkStats.s>=90?'fill-green-600':checkStats.s>0?'fill-slate-700':'fill-red-600'}`}>{checkStats.s}d</text>
                                            
                                            {checkStats.expiring > 0 && (
                                                 <text x="145" y="66" textAnchor="end" className="text-[8px] fill-green-600 italic">({checkStats.expiring} {t.expireMsg})</text>
                                            )}

                                            <line x1="10" y1="72" x2="145" y2="72" stroke="#e2e8f0" strokeDasharray="2,2"/>
                                            
                                            <text x="10" y="86" className="text-[9px] fill-slate-400">{t.sinceLast}:</text>
                                            <text x="145" y="86" textAnchor="end" className="text-[9px] font-bold fill-slate-600">{checkStats.gap.since!==null?checkStats.gap.since+'d':'-'}</text>
                                            
                                            <text x="10" y="100" className="text-[9px] fill-slate-400">{t.untilNext}:</text>
                                            <text x="145" y="100" textAnchor="end" className="text-[9px] font-bold fill-slate-600">{checkStats.gap.until!==null?checkStats.gap.until+'d':'-'}</text>
                                        </g>
                                    </g>
                                )}
                            </svg>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

<script src="https://static.app/js/static.js" type="text/javascript"></script>
</body>
</html>
